<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0b">
    <title>Mathematical Proof Teleprompter</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1e1e22;
            --bg-card: #1a1a1e;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-muted: #6e6e73;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-rose: #f43f5e;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(59, 130, 246, 0.5);
            --shadow-glow: 0 0 60px rgba(59, 130, 246, 0.15);
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --font-display: 'Libre Baskerville', Georgia, serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-ui: 'Source Sans 3', -apple-system, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior: none;
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            /* Prevent text selection on buttons */
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent zoom on double-tap for buttons */
        button, .control-btn, .speed-btn, .btn {
            touch-action: manipulation;
        }

        /* Subtle grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 11, 0.8);
            backdrop-filter: blur(12px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 14px;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Buttons */
        .btn {
            font-family: var(--font-ui);
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            aspect-ratio: 1;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            gap: 2rem;
        }

        /* Input Screen */
        .input-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            gap: 1.5rem;
        }

        .input-header {
            text-align: center;
        }

        .input-header h2 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .input-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        textarea {
            flex: 1;
            min-height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-primary);
            resize: none;
            transition: border-color var(--transition-fast);
        }

        textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Teleprompter Screen */
        .teleprompter-screen {
            flex: 1;
            display: none;
            flex-direction: column;
            gap: 1.5rem;
        }

        .teleprompter-screen.active {
            display: flex;
        }

        .input-screen.hidden {
            display: none;
        }

        /* Display Area */
        .display-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            min-height: 400px;
        }

        .context-previous {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
            min-height: 1.5em;
            transition: opacity var(--transition-smooth);
            text-align: center;
            max-width: 600px;
        }

        .word-display {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            width: 100%;
            max-width: 800px;
        }

        .word-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 2.5rem 4rem;
            box-shadow: var(--shadow-glow);
            text-align: center;
            min-width: 300px;
            max-width: 90%;
            transition: all var(--transition-smooth);
        }

        .current-word {
            font-family: var(--font-display);
            font-size: 4rem;
            font-weight: 400;
            line-height: 1.2;
            color: var(--text-primary);
            word-break: break-word;
            transition: all var(--transition-fast);
        }

        /* Word type colors */
        .word-type-math {
            color: var(--accent-cyan);
        }

        .word-type-punctuation {
            color: var(--text-secondary);
        }

        .word-type-pause {
            color: var(--accent-green);
        }

        /* Pause display */
        .pause-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        .pause-label {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            color: var(--accent-green);
            font-weight: 500;
        }

        .pause-timer {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .pause-progress {
            width: 200px;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .pause-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            border-radius: 4px;
            transition: width 100ms linear;
        }

        .context-next {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-top: 2rem;
            min-height: 1.5em;
            transition: opacity var(--transition-smooth);
            text-align: center;
            max-width: 600px;
        }

        /* Controls Panel */
        .controls-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin: 0 auto;
            max-width: 700px;
            width: 100%;
        }

        .controls-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .control-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .control-btn.play-btn {
            width: 64px;
            height: 64px;
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            border-radius: 50%;
            font-size: 1.5rem;
        }

        .control-btn.play-btn:hover {
            background: #2563eb;
            border-color: #2563eb;
            transform: scale(1.05);
        }

        .control-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .skip-pause-btn {
            padding: 0.5rem 1rem;
            width: auto;
            font-family: var(--font-ui);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .controls-secondary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .speed-control label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .speed-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .speed-btn {
            padding: 0.375rem 0.625rem;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .speed-btn:hover {
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .speed-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-toggle label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            transition: all var(--transition-fast);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
            background: white;
        }

        /* Progress Bar */
        .progress-section {
            margin: 0 auto;
            max-width: 700px;
            width: 100%;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar-wrapper {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
            transition: width 100ms ease-out;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .progress-text {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 100px;
            text-align: right;
        }

        /* Keyboard shortcuts hint */
        .shortcuts-hint {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .shortcuts-hint:hover {
            color: var(--text-secondary);
        }

        .shortcuts-panel {
            position: fixed;
            bottom: 3.5rem;
            right: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .shortcuts-panel.visible {
            display: flex;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
        }

        .shortcut-key {
            font-family: var(--font-mono);
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .word-card {
            animation: fadeIn 0.3s ease-out;
        }

        .playing .current-word {
            animation: pulse 1s ease-in-out infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            /* Make it feel like a native app */
            html, body {
                height: 100%;
                overflow: hidden;
            }

            .app-container {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile browsers */
            }

            header {
                padding: 0.75rem 1rem;
                position: sticky;
                top: 0;
                z-index: 50;
            }

            .logo-text {
                font-size: 0.95rem;
            }

            .logo-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            main {
                padding: 0.75rem;
                gap: 0.5rem;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Ensure content fits in viewport */
                max-height: calc(100vh - 55px);
                max-height: calc(100dvh - 55px);
            }

            /* Input screen mobile */
            .input-screen {
                gap: 0.75rem;
                height: 100%;
                max-height: calc(100vh - 60px);
                max-height: calc(100dvh - 60px);
            }

            .input-header h2 {
                font-size: 1.25rem;
            }

            .input-header p {
                font-size: 0.8rem;
            }

            .input-area {
                flex: 1;
                min-height: 0; /* Important for flex shrinking */
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            textarea {
                flex: 1;
                min-height: 120px;
                max-height: 40vh; /* Limit textarea height */
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            .input-actions {
                flex-direction: column;
                gap: 0.5rem;
                flex-shrink: 0; /* Prevent buttons from shrinking */
                padding-bottom: 0.5rem;
            }

            .input-actions .btn {
                width: 100%;
                justify-content: center;
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }

            /* Teleprompter screen mobile - maximize word display */
            .teleprompter-screen {
                gap: 0.35rem;
                height: 100%;
                max-height: calc(100vh - 55px);
                max-height: calc(100dvh - 55px);
            }

            .display-area {
                padding: 0.5rem;
                min-height: unset;
                flex: 1;
                min-height: 0; /* Allow shrinking */
            }

            .context-previous, .context-next {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
                margin-top: 0.5rem;
                min-height: 1.2em;
            }

            .word-display {
                min-height: 80px;
            }

            .word-card {
                padding: 1rem 1.25rem;
                min-width: unset;
                width: 95%;
                max-width: 95%;
                border-radius: 14px;
            }

            .current-word {
                font-size: 2.5rem;
            }

            .pause-timer {
                font-size: 1.75rem;
            }

            .pause-label {
                font-size: 0.9rem;
            }

            .pause-progress {
                width: 140px;
                height: 6px;
            }

            .pause-display {
                gap: 0.75rem;
            }

            /* Controls - larger touch targets but compact layout */
            .controls-panel {
                padding: 0.6rem 0.75rem;
                border-radius: 12px;
                margin: 0;
                flex-shrink: 0; /* Don't let controls shrink */
            }

            .controls-main {
                gap: 0.3rem;
                margin-bottom: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                /* Larger touch target without visual change */
                position: relative;
            }

            .control-btn svg {
                width: 16px;
                height: 16px;
            }

            .control-btn::before {
                content: '';
                position: absolute;
                inset: -4px;
            }

            .control-btn.play-btn {
                width: 50px;
                height: 50px;
                margin: 0 0.2rem;
            }

            .control-btn.play-btn svg {
                width: 20px;
                height: 20px;
            }

            .skip-pause-btn {
                font-size: 0.7rem;
                padding: 0.35rem 0.6rem;
            }

            .controls-secondary {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .speed-control {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.35rem;
            }

            .speed-control label {
                font-size: 0.75rem;
            }

            .speed-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.2rem;
                width: 100%;
            }

            .speed-btn {
                flex: 1;
                min-width: calc(14.28% - 0.2rem); /* 7 buttons */
                padding: 0.4rem 0.15rem;
                font-size: 0.65rem;
                text-align: center;
            }

            .mode-toggle {
                justify-content: space-between;
                padding-top: 0.4rem;
                border-top: 1px solid var(--border-subtle);
            }

            .mode-toggle label {
                font-size: 0.75rem;
            }

            .toggle-switch {
                width: 38px;
                height: 20px;
            }

            .toggle-slider::before {
                height: 14px;
                width: 14px;
                left: 2px;
                bottom: 2px;
            }

            .toggle-switch input:checked + .toggle-slider::before {
                transform: translateX(18px);
            }

            /* Progress section */
            .progress-section {
                padding: 0 0.25rem;
                flex-shrink: 0;
            }

            .progress-container {
                gap: 0.5rem;
            }

            .progress-bar-wrapper {
                height: 5px;
            }

            .progress-bar::after {
                width: 10px;
                height: 10px;
            }

            .progress-text {
                font-size: 0.65rem;
                min-width: 60px;
            }

            .stats-bar {
                gap: 0.75rem;
                padding: 0.35rem;
                font-size: 0.65rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .stat-item {
                gap: 0.25rem;
            }

            /* Hide keyboard shortcuts on mobile */
            .shortcuts-hint, .shortcuts-panel {
                display: none !important;
            }

            /* Settings modal mobile */
            .modal {
                width: 95%;
                max-height: 90vh;
                padding: 1.25rem;
            }

            /* Header actions */
            .header-actions {
                gap: 0.5rem;
            }

            .btn-icon {
                padding: 0.4rem;
            }

            #newScriptBtn span, #newScriptBtn svg + span {
                display: none;
            }

            #newScriptBtn {
                padding: 0.5rem;
            }
        }

        /* Extra small screens (iPhone SE, etc) */
        @media (max-width: 375px) {
            .current-word {
                font-size: 2rem;
            }

            .word-card {
                padding: 0.75rem 1rem;
            }

            .control-btn {
                width: 36px;
                height: 36px;
            }

            .control-btn.play-btn {
                width: 44px;
                height: 44px;
            }

            .speed-btn {
                padding: 0.35rem 0.1rem;
                font-size: 0.6rem;
            }

            .context-previous, .context-next {
                font-size: 0.8rem;
            }

            .stats-bar {
                font-size: 0.6rem;
                gap: 0.5rem;
            }

            .input-header h2 {
                font-size: 1.1rem;
            }

            textarea {
                max-height: 35vh;
            }
        }

        /* Landscape mobile - prioritize word display */
        @media (max-width: 896px) and (orientation: landscape) {
            .display-area {
                padding: 0.25rem;
            }

            .context-previous, .context-next {
                font-size: 0.75rem;
                margin: 0.25rem 0;
            }

            .word-card {
                padding: 0.5rem 1rem;
            }

            .current-word {
                font-size: 1.75rem;
            }

            .controls-panel {
                padding: 0.4rem 0.6rem;
            }

            .controls-main {
                margin-bottom: 0.35rem;
            }

            .control-btn {
                width: 32px;
                height: 32px;
            }

            .control-btn.play-btn {
                width: 40px;
                height: 40px;
            }

            .stats-bar {
                padding: 0.2rem;
                font-size: 0.6rem;
            }

            .speed-btn {
                padding: 0.3rem 0.1rem;
                font-size: 0.55rem;
            }

            textarea {
                max-height: 30vh;
            }
        }

        /* High-DPI / tall phones (like 2868x1320 which is ~430px CSS width on 3x) */
        @media (max-width: 500px) and (min-height: 700px) {
            textarea {
                max-height: 45vh;
            }

            .teleprompter-screen {
                gap: 0.5rem;
            }

            .display-area {
                padding: 0.75rem 0.5rem;
            }

            .current-word {
                font-size: 2.75rem;
            }

            .word-card {
                padding: 1.25rem 1.5rem;
            }
        }

        /* PWA / Fullscreen styles */
        @media (display-mode: standalone), (display-mode: fullscreen) {
            header {
                padding-top: env(safe-area-inset-top, 0.75rem);
            }

            .progress-section {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .control-btn:hover {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                border-color: var(--border-subtle);
            }

            .control-btn.play-btn:hover {
                background: var(--accent-blue);
                border-color: var(--accent-blue);
                transform: none;
            }

            .control-btn:active {
                background: var(--bg-card);
                color: var(--text-primary);
                transform: scale(0.95);
            }

            .control-btn.play-btn:active {
                background: #2563eb;
                transform: scale(0.95);
            }

            .speed-btn:hover {
                background: var(--bg-tertiary);
                color: var(--text-muted);
            }

            .speed-btn:active {
                background: var(--bg-card);
            }

            .btn:hover {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
            }

            .btn:active {
                background: var(--bg-card);
                color: var(--text-primary);
            }
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .modal-section {
            margin-bottom: 1.25rem;
        }

        .modal-section label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .modal-section input[type="range"] {
            width: 100%;
            accent-color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        /* Statistics display */
        .stats-bar {
            display: flex;
            gap: 2rem;
            justify-content: center;
            padding: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-family: var(--font-mono);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <div class="logo-icon">∫</div>
                <span class="logo-text">Math Proof Teleprompter</span>
            </div>
            <div class="header-actions">
                <button class="btn" id="newScriptBtn" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    New Script
                </button>
                <button class="btn btn-icon" id="settingsBtn" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Input Screen -->
            <div class="input-screen" id="inputScreen">
                <div class="input-header">
                    <h2>Load Your Script</h2>
                    <p>Paste your word-by-word formatted text or upload a .txt file</p>
                </div>
                <div class="input-area">
                    <textarea id="scriptInput" placeholder="Paste your script here...

Example format (one word per line):
Thus
comma
[PAUSE 2 seconds]
cap
L
open
bracket

Or space-separated:
Thus comma [PAUSE 2 seconds] cap L open bracket"></textarea>
                    <div class="input-actions">
                        <div class="file-input-wrapper">
                            <button class="btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Upload File
                            </button>
                            <input type="file" id="fileInput" accept=".txt">
                        </div>
                        <button class="btn btn-primary" id="loadScriptBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Start Teleprompter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Teleprompter Screen -->
            <div class="teleprompter-screen" id="teleprompterScreen">
                <div class="display-area">
                    <div class="context-previous" id="contextPrevious"></div>
                    <div class="word-display">
                        <div class="word-card" id="wordCard">
                            <div class="current-word" id="currentWord">Ready</div>
                            <div class="pause-display" id="pauseDisplay" style="display: none;">
                                <div class="pause-label">PAUSE</div>
                                <div class="pause-timer" id="pauseTimer">0.0s</div>
                                <div class="pause-progress">
                                    <div class="pause-progress-bar" id="pauseProgressBar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="context-next" id="contextNext"></div>
                </div>

                <div class="controls-panel">
                    <div class="controls-main">
                        <button class="control-btn" id="homeBtn" title="Go to start (Home)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="11 17 6 12 11 7"></polyline>
                                <polyline points="18 17 13 12 18 7"></polyline>
                            </svg>
                        </button>
                        <button class="control-btn" id="rewind5Btn" title="Rewind 5 words (Shift+←)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 19 2 12 11 5 11 19"></polygon>
                                <polygon points="22 19 13 12 22 5 22 19"></polygon>
                            </svg>
                        </button>
                        <button class="control-btn" id="prevBtn" title="Previous word (←)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="19 20 9 12 19 4 19 20"></polygon>
                                <line x1="5" y1="19" x2="5" y2="5"></line>
                            </svg>
                        </button>
                        <button class="control-btn play-btn" id="playBtn" title="Play/Pause (Space)">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="playIcon">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="pauseIcon" style="display: none;">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                        </button>
                        <button class="control-btn" id="nextBtn" title="Next word (→)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                                <line x1="19" y1="5" x2="19" y2="19"></line>
                            </svg>
                        </button>
                        <button class="control-btn" id="forward5Btn" title="Forward 5 words (Shift+→)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                                <polygon points="2 19 11 12 2 5 2 19"></polygon>
                            </svg>
                        </button>
                        <button class="control-btn" id="endBtn" title="Go to end (End)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="13 17 18 12 13 7"></polyline>
                                <polyline points="6 17 11 12 6 7"></polyline>
                            </svg>
                        </button>
                        <button class="control-btn skip-pause-btn" id="skipPauseBtn" title="Skip pause (S)" style="display: none;">
                            Skip Pause
                        </button>
                    </div>
                    <div class="controls-secondary">
                        <div class="speed-control">
                            <label>Speed:</label>
                            <div class="speed-buttons">
                                <button class="speed-btn" data-speed="0.5">0.5s</button>
                                <button class="speed-btn active" data-speed="1">1s</button>
                                <button class="speed-btn" data-speed="1.5">1.5s</button>
                                <button class="speed-btn" data-speed="2">2s</button>
                                <button class="speed-btn" data-speed="3">3s</button>
                                <button class="speed-btn" data-speed="4">4s</button>
                                <button class="speed-btn" data-speed="5">5s</button>
                            </div>
                        </div>
                        <div class="mode-toggle">
                            <label>Auto-play:</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="autoplayToggle" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-container">
                        <div class="progress-bar-wrapper" id="progressBarWrapper">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-text" id="progressText">0 / 0</div>
                    </div>
                    <div class="stats-bar">
                        <div class="stat-item">
                            <span>Elapsed:</span>
                            <span class="stat-value" id="elapsedTime">0:00</span>
                        </div>
                        <div class="stat-item">
                            <span>Remaining:</span>
                            <span class="stat-value" id="remainingTime">0:00</span>
                        </div>
                        <div class="stat-item">
                            <span>WPM:</span>
                            <span class="stat-value" id="wpmStat">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Keyboard shortcuts hint -->
        <div class="shortcuts-hint" id="shortcutsHint">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
                <line x1="6" y1="8" x2="6" y2="8"></line>
                <line x1="10" y1="8" x2="10" y2="8"></line>
                <line x1="14" y1="8" x2="14" y2="8"></line>
                <line x1="18" y1="8" x2="18" y2="8"></line>
                <line x1="6" y1="12" x2="18" y2="12"></line>
                <line x1="6" y1="16" x2="6" y2="16"></line>
                <line x1="18" y1="16" x2="18" y2="16"></line>
            </svg>
            Keyboard shortcuts
        </div>

        <div class="shortcuts-panel" id="shortcutsPanel">
            <div class="shortcut-row"><span>Play/Pause</span><span class="shortcut-key">Space</span></div>
            <div class="shortcut-row"><span>Next word</span><span class="shortcut-key">→</span></div>
            <div class="shortcut-row"><span>Previous word</span><span class="shortcut-key">←</span></div>
            <div class="shortcut-row"><span>Skip 5 forward</span><span class="shortcut-key">Shift+→</span></div>
            <div class="shortcut-row"><span>Rewind 5</span><span class="shortcut-key">Shift+←</span></div>
            <div class="shortcut-row"><span>Skip pause</span><span class="shortcut-key">S</span></div>
            <div class="shortcut-row"><span>Toggle mode</span><span class="shortcut-key">M</span></div>
            <div class="shortcut-row"><span>Speed up</span><span class="shortcut-key">+</span></div>
            <div class="shortcut-row"><span>Slow down</span><span class="shortcut-key">-</span></div>
            <div class="shortcut-row"><span>Go to start</span><span class="shortcut-key">Home</span></div>
            <div class="shortcut-row"><span>Go to end</span><span class="shortcut-key">End</span></div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="modal">
                <h3>Settings</h3>
                <div class="modal-section">
                    <label>Font Size: <span id="fontSizeValue">48</span>px</label>
                    <input type="range" id="fontSizeSlider" min="24" max="96" value="48">
                </div>
                <div class="modal-section">
                    <label>Context Words (before/after): <span id="contextWordsValue">2</span></label>
                    <input type="range" id="contextWordsSlider" min="0" max="5" value="2">
                </div>
                <div class="modal-actions">
                    <button class="btn" id="closeSettingsBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = {
            words: [],
            currentIndex: 0,
            isPlaying: false,
            isAutoplay: true,
            speed: 1, // seconds per word
            isPaused: false,
            pauseRemaining: 0,
            pauseDuration: 0,
            playInterval: null,
            pauseInterval: null,
            startTime: null,
            wordsRead: 0,
            fontSize: 48,
            contextWords: 2
        };

        // DOM Elements
        const elements = {
            inputScreen: document.getElementById('inputScreen'),
            teleprompterScreen: document.getElementById('teleprompterScreen'),
            scriptInput: document.getElementById('scriptInput'),
            fileInput: document.getElementById('fileInput'),
            loadScriptBtn: document.getElementById('loadScriptBtn'),
            newScriptBtn: document.getElementById('newScriptBtn'),
            currentWord: document.getElementById('currentWord'),
            wordCard: document.getElementById('wordCard'),
            pauseDisplay: document.getElementById('pauseDisplay'),
            pauseTimer: document.getElementById('pauseTimer'),
            pauseProgressBar: document.getElementById('pauseProgressBar'),
            contextPrevious: document.getElementById('contextPrevious'),
            contextNext: document.getElementById('contextNext'),
            playBtn: document.getElementById('playBtn'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            rewind5Btn: document.getElementById('rewind5Btn'),
            forward5Btn: document.getElementById('forward5Btn'),
            homeBtn: document.getElementById('homeBtn'),
            endBtn: document.getElementById('endBtn'),
            skipPauseBtn: document.getElementById('skipPauseBtn'),
            speedBtns: document.querySelectorAll('.speed-btn'),
            autoplayToggle: document.getElementById('autoplayToggle'),
            progressBar: document.getElementById('progressBar'),
            progressBarWrapper: document.getElementById('progressBarWrapper'),
            progressText: document.getElementById('progressText'),
            elapsedTime: document.getElementById('elapsedTime'),
            remainingTime: document.getElementById('remainingTime'),
            wpmStat: document.getElementById('wpmStat'),
            shortcutsHint: document.getElementById('shortcutsHint'),
            shortcutsPanel: document.getElementById('shortcutsPanel'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            fontSizeSlider: document.getElementById('fontSizeSlider'),
            fontSizeValue: document.getElementById('fontSizeValue'),
            contextWordsSlider: document.getElementById('contextWordsSlider'),
            contextWordsValue: document.getElementById('contextWordsValue')
        };

        // Math-related words for color coding
        const mathWords = new Set([
            'cap', 'open', 'close', 'bracket', 'paren', 'parenthesis', 'brace',
            'epsilon', 'delta', 'alpha', 'beta', 'gamma', 'theta', 'lambda', 'sigma', 'pi',
            'infinity', 'integral', 'sum', 'product', 'sqrt', 'root',
            'plus', 'minus', 'times', 'divided', 'equals', 'greater', 'less',
            'subset', 'superset', 'union', 'intersection', 'element', 'belongs',
            'forall', 'exists', 'implies', 'iff', 'not', 'and', 'or',
            'lim', 'limit', 'derivative', 'partial',
            'subscript', 'superscript', 'sub', 'sup', 'power', 'squared', 'cubed'
        ]);

        const punctuationWords = new Set([
            'comma', 'period', 'colon', 'semicolon', 'dot', 'ellipsis',
            'question', 'exclamation', 'apostrophe', 'quote', 'dash', 'hyphen'
        ]);

        // Parse input text into words array
        function parseScript(text) {
            const lines = text.trim().split('\n').map(l => l.trim()).filter(l => l);
            const words = [];
            
            // Check if it's line-by-line format or space-separated
            const isLineByLine = lines.length > 1 && !lines[0].includes('[PAUSE') && lines[0].split(/\s+/).length <= 2;
            
            if (isLineByLine) {
                // Line-by-line format
                for (const line of lines) {
                    if (line.match(/^\[PAUSE\s+[\d.]+\s*seconds?\]$/i)) {
                        const match = line.match(/[\d.]+/);
                        words.push({
                            type: 'pause',
                            duration: parseFloat(match[0]),
                            text: line
                        });
                    } else {
                        words.push({
                            type: getWordType(line),
                            text: line
                        });
                    }
                }
            } else {
                // Space-separated format - need to handle [PAUSE X seconds] specially
                const fullText = lines.join(' ');
                const tokens = [];
                let current = '';
                let inPause = false;
                
                for (let i = 0; i < fullText.length; i++) {
                    const char = fullText[i];
                    
                    if (char === '[') {
                        if (current.trim()) tokens.push(current.trim());
                        current = '[';
                        inPause = true;
                    } else if (char === ']' && inPause) {
                        current += ']';
                        tokens.push(current);
                        current = '';
                        inPause = false;
                    } else if (char === ' ' && !inPause) {
                        if (current.trim()) tokens.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                if (current.trim()) tokens.push(current.trim());
                
                for (const token of tokens) {
                    if (token.match(/^\[PAUSE\s+[\d.]+\s*seconds?\]$/i)) {
                        const match = token.match(/[\d.]+/);
                        words.push({
                            type: 'pause',
                            duration: parseFloat(match[0]),
                            text: token
                        });
                    } else {
                        words.push({
                            type: getWordType(token),
                            text: token
                        });
                    }
                }
            }
            
            return words;
        }

        function getWordType(word) {
            const lower = word.toLowerCase();
            if (mathWords.has(lower)) return 'math';
            if (punctuationWords.has(lower)) return 'punctuation';
            return 'text';
        }

        // Display current word
        function displayWord() {
            if (state.words.length === 0) return;
            
            const word = state.words[state.currentIndex];
            
            if (word.type === 'pause') {
                elements.currentWord.style.display = 'none';
                elements.pauseDisplay.style.display = 'flex';
                elements.skipPauseBtn.style.display = 'block';
                state.pauseDuration = word.duration * state.speed;
                state.pauseRemaining = state.pauseDuration;
                updatePauseDisplay();
            } else {
                elements.currentWord.style.display = 'block';
                elements.pauseDisplay.style.display = 'none';
                elements.skipPauseBtn.style.display = 'none';
                elements.currentWord.textContent = word.text;
                
                // Apply word type class
                elements.currentWord.className = 'current-word';
                if (word.type === 'math') {
                    elements.currentWord.classList.add('word-type-math');
                } else if (word.type === 'punctuation') {
                    elements.currentWord.classList.add('word-type-punctuation');
                }
            }
            
            // Update context
            updateContext();
            
            // Update progress
            updateProgress();
            
            // Update estimated time
            updateEstimatedTime();
            
            // Save to localStorage
            saveProgress();
        }

        function updateContext() {
            const n = state.contextWords;
            
            // Previous context
            const prevWords = [];
            for (let i = Math.max(0, state.currentIndex - n); i < state.currentIndex; i++) {
                if (state.words[i].type !== 'pause') {
                    prevWords.push(state.words[i].text);
                } else {
                    prevWords.push('⏸');
                }
            }
            elements.contextPrevious.textContent = prevWords.join(' ');
            
            // Next context
            const nextWords = [];
            for (let i = state.currentIndex + 1; i <= Math.min(state.words.length - 1, state.currentIndex + n + 1); i++) {
                if (state.words[i].type !== 'pause') {
                    nextWords.push(state.words[i].text);
                } else {
                    nextWords.push('⏸');
                }
            }
            elements.contextNext.textContent = nextWords.join(' ');
        }

        function updatePauseDisplay() {
            elements.pauseTimer.textContent = state.pauseRemaining.toFixed(1) + 's';
            const progress = ((state.pauseDuration - state.pauseRemaining) / state.pauseDuration) * 100;
            elements.pauseProgressBar.style.width = progress + '%';
        }

        function updateProgress() {
            const progress = ((state.currentIndex + 1) / state.words.length) * 100;
            elements.progressBar.style.width = progress + '%';
            elements.progressText.textContent = `${state.currentIndex + 1} / ${state.words.length}`;
        }

        function updateEstimatedTime() {
            // Calculate remaining time based on remaining words and pauses
            let remainingSeconds = 0;
            
            for (let i = state.currentIndex + 1; i < state.words.length; i++) {
                const word = state.words[i];
                if (word.type === 'pause') {
                    // Pause duration is also affected by speed multiplier
                    remainingSeconds += word.duration * state.speed;
                } else {
                    remainingSeconds += state.speed;
                }
            }
            
            // If currently on a pause, add remaining pause time
            if (state.words[state.currentIndex]?.type === 'pause' && state.pauseRemaining > 0) {
                remainingSeconds += state.pauseRemaining;
            }
            
            // Format as mm:ss or hh:mm:ss
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = Math.floor(remainingSeconds % 60);
            
            if (hours > 0) {
                elements.remainingTime.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                elements.remainingTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateStats() {
            if (!state.startTime) return;
            
            const elapsed = (Date.now() - state.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            elements.elapsedTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate WPM (only counting text words, not pauses)
            const textWordsRead = state.words.slice(0, state.currentIndex + 1)
                .filter(w => w.type !== 'pause').length;
            const wpm = elapsed > 0 ? Math.round((textWordsRead / elapsed) * 60) : 0;
            elements.wpmStat.textContent = wpm;
        }

        // Playback controls
        function play() {
            if (state.currentIndex >= state.words.length - 1) {
                state.currentIndex = 0;
                displayWord();
            }
            
            state.isPlaying = true;
            if (!state.startTime) state.startTime = Date.now();
            
            elements.playIcon.style.display = 'none';
            elements.pauseIcon.style.display = 'block';
            elements.wordCard.classList.add('playing');
            
            const word = state.words[state.currentIndex];
            
            if (word.type === 'pause') {
                startPauseCountdown();
            } else {
                scheduleNextWord();
            }
        }

        function pause() {
            state.isPlaying = false;
            
            elements.playIcon.style.display = 'block';
            elements.pauseIcon.style.display = 'none';
            elements.wordCard.classList.remove('playing');
            
            clearInterval(state.playInterval);
            clearInterval(state.pauseInterval);
        }

        function togglePlay() {
            if (state.isPlaying) {
                pause();
            } else {
                play();
            }
        }

        function scheduleNextWord() {
            clearInterval(state.playInterval);
            
            state.playInterval = setTimeout(() => {
                if (!state.isPlaying || !state.isAutoplay) return;
                
                if (state.currentIndex < state.words.length - 1) {
                    state.currentIndex++;
                    displayWord();
                    
                    const word = state.words[state.currentIndex];
                    if (word.type === 'pause') {
                        startPauseCountdown();
                    } else {
                        scheduleNextWord();
                    }
                } else {
                    pause();
                }
                
                updateStats();
            }, state.speed * 1000);
        }

        function startPauseCountdown() {
            clearInterval(state.pauseInterval);
            
            const updateInterval = 100; // ms
            state.pauseInterval = setInterval(() => {
                if (!state.isPlaying) return;
                
                state.pauseRemaining -= updateInterval / 1000;
                
                if (state.pauseRemaining <= 0) {
                    clearInterval(state.pauseInterval);
                    advanceFromPause();
                } else {
                    updatePauseDisplay();
                }
            }, updateInterval);
        }

        function advanceFromPause() {
            if (state.currentIndex < state.words.length - 1) {
                state.currentIndex++;
                displayWord();
                
                if (state.isPlaying && state.isAutoplay) {
                    const word = state.words[state.currentIndex];
                    if (word.type === 'pause') {
                        startPauseCountdown();
                    } else {
                        scheduleNextWord();
                    }
                }
            } else {
                pause();
            }
            
            updateStats();
        }

        function skipPause() {
            if (state.words[state.currentIndex]?.type === 'pause') {
                clearInterval(state.pauseInterval);
                advanceFromPause();
            }
        }

        function goToWord(index) {
            const wasPlaying = state.isPlaying;
            if (wasPlaying) pause();
            
            state.currentIndex = Math.max(0, Math.min(state.words.length - 1, index));
            displayWord();
            
            if (wasPlaying && state.isAutoplay) play();
            updateStats();
        }

        function nextWord() {
            goToWord(state.currentIndex + 1);
        }

        function prevWord() {
            goToWord(state.currentIndex - 1);
        }

        function rewind5() {
            goToWord(state.currentIndex - 5);
        }

        function forward5() {
            goToWord(state.currentIndex + 5);
        }

        function goToStart() {
            goToWord(0);
        }

        function goToEnd() {
            goToWord(state.words.length - 1);
        }

        function setSpeed(speed) {
            state.speed = speed;
            elements.speedBtns.forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
            });
            localStorage.setItem('teleprompter_speed', speed);
            
            // Update estimated time when speed changes
            if (state.words.length > 0) {
                updateEstimatedTime();
            }
        }

        function cycleSpeed(direction) {
            const speeds = [0.5, 1, 1.5, 2, 3, 4, 5];
            const currentIdx = speeds.indexOf(state.speed);
            let newIdx = currentIdx + direction;
            if (newIdx < 0) newIdx = speeds.length - 1;
            if (newIdx >= speeds.length) newIdx = 0;
            setSpeed(speeds[newIdx]);
        }

        // localStorage
        function saveProgress() {
            const data = {
                index: state.currentIndex,
                hash: hashScript(state.words)
            };
            localStorage.setItem('teleprompter_progress', JSON.stringify(data));
        }

        function loadProgress() {
            try {
                const data = JSON.parse(localStorage.getItem('teleprompter_progress'));
                if (data && data.hash === hashScript(state.words)) {
                    state.currentIndex = Math.min(data.index, state.words.length - 1);
                }
            } catch (e) {}
        }

        function hashScript(words) {
            return words.length + '_' + (words[0]?.text || '') + '_' + (words[words.length - 1]?.text || '');
        }

        // Event Listeners
        elements.loadScriptBtn.addEventListener('click', () => {
            const text = elements.scriptInput.value.trim();
            if (!text) return;
            
            state.words = parseScript(text);
            if (state.words.length === 0) return;
            
            loadProgress();
            
            elements.inputScreen.classList.add('hidden');
            elements.teleprompterScreen.classList.add('active');
            elements.newScriptBtn.style.display = 'flex';
            
            displayWord();
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                elements.scriptInput.value = event.target.result;
            };
            reader.readAsText(file);
        });

        elements.newScriptBtn.addEventListener('click', () => {
            pause();
            state.words = [];
            state.currentIndex = 0;
            state.startTime = null;
            
            elements.inputScreen.classList.remove('hidden');
            elements.teleprompterScreen.classList.remove('active');
            elements.newScriptBtn.style.display = 'none';
            elements.scriptInput.value = '';
        });

        elements.playBtn.addEventListener('click', togglePlay);
        elements.prevBtn.addEventListener('click', prevWord);
        elements.nextBtn.addEventListener('click', nextWord);
        elements.rewind5Btn.addEventListener('click', rewind5);
        elements.forward5Btn.addEventListener('click', forward5);
        elements.homeBtn.addEventListener('click', goToStart);
        elements.endBtn.addEventListener('click', goToEnd);
        elements.skipPauseBtn.addEventListener('click', skipPause);

        elements.speedBtns.forEach(btn => {
            btn.addEventListener('click', () => setSpeed(parseFloat(btn.dataset.speed)));
        });

        elements.autoplayToggle.addEventListener('change', (e) => {
            state.isAutoplay = e.target.checked;
        });

        elements.progressBarWrapper.addEventListener('click', (e) => {
            const rect = elements.progressBarWrapper.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const index = Math.round(percent * (state.words.length - 1));
            goToWord(index);
        });

        // Shortcuts panel
        elements.shortcutsHint.addEventListener('click', () => {
            elements.shortcutsPanel.classList.toggle('visible');
        });

        document.addEventListener('click', (e) => {
            if (!elements.shortcutsHint.contains(e.target) && !elements.shortcutsPanel.contains(e.target)) {
                elements.shortcutsPanel.classList.remove('visible');
            }
        });

        // Settings
        elements.settingsBtn.addEventListener('click', () => {
            elements.settingsModal.classList.add('visible');
        });

        elements.closeSettingsBtn.addEventListener('click', () => {
            elements.settingsModal.classList.remove('visible');
        });

        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) {
                elements.settingsModal.classList.remove('visible');
            }
        });

        elements.fontSizeSlider.addEventListener('input', (e) => {
            state.fontSize = parseInt(e.target.value);
            elements.fontSizeValue.textContent = state.fontSize;
            elements.currentWord.style.fontSize = state.fontSize + 'px';
            localStorage.setItem('teleprompter_fontSize', state.fontSize);
        });

        elements.contextWordsSlider.addEventListener('input', (e) => {
            state.contextWords = parseInt(e.target.value);
            elements.contextWordsValue.textContent = state.contextWords;
            updateContext();
            localStorage.setItem('teleprompter_contextWords', state.contextWords);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in textarea
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            
            // Don't trigger if teleprompter not active
            if (!elements.teleprompterScreen.classList.contains('active')) return;
            
            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (e.shiftKey) forward5();
                    else nextWord();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (e.shiftKey) rewind5();
                    else prevWord();
                    break;
                case 's':
                case 'S':
                    skipPause();
                    break;
                case 'm':
                case 'M':
                    elements.autoplayToggle.checked = !elements.autoplayToggle.checked;
                    state.isAutoplay = elements.autoplayToggle.checked;
                    break;
                case '+':
                case '=':
                    cycleSpeed(-1); // Faster (lower number)
                    break;
                case '-':
                case '_':
                    cycleSpeed(1); // Slower (higher number)
                    break;
                case 'Home':
                    e.preventDefault();
                    goToStart();
                    break;
                case 'End':
                    e.preventDefault();
                    goToEnd();
                    break;
            }
        });

        // Load saved settings
        function loadSettings() {
            const savedSpeed = localStorage.getItem('teleprompter_speed');
            if (savedSpeed) setSpeed(parseFloat(savedSpeed));
            
            const savedFontSize = localStorage.getItem('teleprompter_fontSize');
            if (savedFontSize) {
                state.fontSize = parseInt(savedFontSize);
                elements.fontSizeSlider.value = state.fontSize;
                elements.fontSizeValue.textContent = state.fontSize;
                elements.currentWord.style.fontSize = state.fontSize + 'px';
            }
            
            const savedContextWords = localStorage.getItem('teleprompter_contextWords');
            if (savedContextWords) {
                state.contextWords = parseInt(savedContextWords);
                elements.contextWordsSlider.value = state.contextWords;
                elements.contextWordsValue.textContent = state.contextWords;
            }
        }

        loadSettings();
    </script>
</body>
</html>
